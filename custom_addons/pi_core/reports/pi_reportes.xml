<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Reporte: Información de Usuario -->
    <record id="action_report_usuario_info" model="ir.actions.report">
        <field name="name">Información de Usuario</field>
        <field name="model">pi.usuario</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">pi_core.report_usuario_info</field>
        <field name="report_file">pi_core.report_usuario_info</field>
        <field name="print_report_name">'Información de Usuario - %s' % (object.name or 'Usuario')</field>
    </record>

    <!-- Plantilla QWeb: Información de Usuario -->
    <template id="report_usuario_info">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="usuario">
                <t t-call="web.external_layout">
                    <div class="page">
                        <div class="oe_structure"/>
                        
                        <!-- Encabezado del Usuario -->
                        <div class="row">
                            <div class="col-12">
                                <h1 class="text-center">Información de Usuario</h1>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-3">
                                <t t-if="usuario.image_1920">
                                    <img t-att-src="'data:image/png;base64,%s' % usuario.image_1920" 
                                         style="max-width: 150px; max-height: 150px; border-radius: 50%;"/>
                                </t>
                            </div>
                            <div class="col-9">
                                <h2 t-esc="usuario.name or 'Sin nombre'"/>
                                <p>
                                    <strong>ID Usuario:</strong> <span t-esc="usuario.id_usuario"/>
                                </p>
                                <p>
                                    <strong>Email:</strong> <span t-esc="usuario.email or 'No disponible'"/>
                                </p>
                                <p>
                                    <strong>Teléfono:</strong> <span t-esc="usuario.phone or 'No disponible'"/>
                                </p>
                                <p>
                                    <strong>Fecha de Registro:</strong> 
                                    <span t-esc="usuario.fecha_registro.strftime('%d/%m/%Y') if usuario.fecha_registro else 'No disponible'"/>
                                </p>
                                <p>
                                    <strong>Antigüedad:</strong> 
                                    <span t-esc="'%d días' % usuario.antiguedad if usuario.antiguedad else '0 días'"/>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Estadísticas -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Estadísticas</h3>
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <td style="width: 25%; padding: 10px;"><strong>Valoración Promedio</strong></td>
                                            <td style="padding: 10px;">
                                                <span t-esc="'{:.1f}/5.0'.format(usuario.valoracion_promedio) if usuario.valoracion_promedio else 'Sin valoraciones'"/>
                                                <t t-if="usuario.total_valoraciones">
                                                    <small class="text-muted">
                                                        (<span t-esc="usuario.total_valoraciones"/> valoraciones)
                                                    </small>
                                                </t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 10px;"><strong>Productos en Venta</strong></td>
                                            <td style="padding: 10px;">
                                                <span t-esc="usuario.total_productos_venta"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 10px;"><strong>Productos Vendidos</strong></td>
                                            <td style="padding: 10px;">
                                                <span t-esc="usuario.total_productos_vendidos"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="padding: 10px;"><strong>Productos Comprados</strong></td>
                                            <td style="padding: 10px;">
                                                <span t-esc="usuario.total_productos_comprados"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Productos en Venta -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Productos en Venta</h3>
                                <t t-if="usuario.productos_venta">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr style="background-color: #f0f0f0;">
                                                <th style="text-align: left; padding: 10px;">ID Producto</th>
                                                <th style="text-align: left; padding: 10px;">Nombre</th>
                                                <th style="text-align: left; padding: 10px;">Categoría</th>
                                                <th style="text-align: right; padding: 10px;">Precio (€)</th>
                                                <th style="text-align: center; padding: 10px;">Estado</th>
                                                <th style="text-align: center; padding: 10px;">Fecha Publicación</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="usuario.productos_venta" t-as="producto">
                                                <tr>
                                                    <td style="padding: 8px;" t-esc="producto.id_producto"/>
                                                    <td style="padding: 8px;" t-esc="producto.nombre_producto"/>
                                                    <td style="padding: 8px;" t-esc="producto.categoria_id.nombre if producto.categoria_id else 'Sin categoría'"/>
                                                    <td style="text-align: right; padding: 8px;">
                                                        <span t-esc="'{:.2f}'.format(producto.precio)"/>
                                                    </td>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <span t-esc="dict(producto._fields['estado_venta'].selection).get(producto.estado_venta, producto.estado_venta)"/>
                                                    </td>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <span t-esc="producto.fecha_publicacion.strftime('%d/%m/%Y') if producto.fecha_publicacion else 'N/A'"/>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </t>
                                <t t-if="not usuario.productos_venta">
                                    <p><em>No tiene productos en venta actualmente</em></p>
                                </t>
                            </div>
                        </div>
                        
                        <!-- Productos Vendidos -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Productos Vendidos</h3>
                                <t t-if="usuario.productos_vendidos">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr style="background-color: #f0f0f0;">
                                                <th style="text-align: left; padding: 10px;">ID Compra</th>
                                                <th style="text-align: left; padding: 10px;">Producto</th>
                                                <th style="text-align: left; padding: 10px;">Comprador</th>
                                                <th style="text-align: right; padding: 10px;">Monto (€)</th>
                                                <th style="text-align: center; padding: 10px;">Fecha</th>
                                                <th style="text-align: center; padding: 10px;">Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="usuario.productos_vendidos" t-as="compra">
                                                <tr>
                                                    <td style="padding: 8px;" t-esc="compra.id_compra"/>
                                                    <td style="padding: 8px;" t-esc="compra.producto_id.nombre_producto if compra.producto_id else 'N/A'"/>
                                                    <td style="padding: 8px;" t-esc="compra.comprador_id.name if compra.comprador_id else 'N/A'"/>
                                                    <td style="text-align: right; padding: 8px;">
                                                        <span t-esc="'{:.2f}'.format(compra.monto)"/>
                                                    </td>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <span t-esc="compra.fecha.strftime('%d/%m/%Y') if compra.fecha else 'N/A'"/>
                                                    </td>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <span t-esc="dict(compra._fields['estado'].selection).get(compra.estado, compra.estado)"/>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                        <tfoot>
                                            <tr style="background-color: #f8f9fa;">
                                                <td colspan="3" style="text-align: right; padding: 10px;"><strong>Total:</strong></td>
                                                <td style="text-align: right; padding: 10px;">
                                                    <strong t-esc="'{:.2f}'.format(sum(usuario.productos_vendidos.mapped('monto')))"/>
                                                </td>
                                                <td colspan="2"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </t>
                                <t t-if="not usuario.productos_vendidos">
                                    <p><em>No ha vendido ningún producto</em></p>
                                </t>
                            </div>
                        </div>
                        
                        <!-- Productos Comprados -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Productos Comprados</h3>
                                <t t-if="usuario.productos_comprados">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr style="background-color: #f0f0f0;">
                                                <th style="text-align: left; padding: 10px;">ID Compra</th>
                                                <th style="text-align: left; padding: 10px;">Producto</th>
                                                <th style="text-align: left; padding: 10px;">Vendedor</th>
                                                <th style="text-align: right; padding: 10px;">Monto (€)</th>
                                                <th style="text-align: center; padding: 10px;">Fecha</th>
                                                <th style="text-align: center; padding: 10px;">Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="usuario.productos_comprados" t-as="compra">
                                                <tr>
                                                    <td style="padding: 8px;" t-esc="compra.id_compra"/>
                                                    <td style="padding: 8px;" t-esc="compra.producto_id.nombre_producto if compra.producto_id else 'N/A'"/>
                                                    <td style="padding: 8px;" t-esc="compra.vendedor_id.name if compra.vendedor_id else 'N/A'"/>
                                                    <td style="text-align: right; padding: 8px;">
                                                        <span t-esc="'{:.2f}'.format(compra.monto)"/>
                                                    </td>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <span t-esc="compra.fecha.strftime('%d/%m/%Y') if compra.fecha else 'N/A'"/>
                                                    </td>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <span t-esc="dict(compra._fields['estado'].selection).get(compra.estado, compra.estado)"/>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                        <tfoot>
                                            <tr style="background-color: #f8f9fa;">
                                                <td colspan="3" style="text-align: right; padding: 10px;"><strong>Total:</strong></td>
                                                <td style="text-align: right; padding: 10px;">
                                                    <strong t-esc="'{:.2f}'.format(sum(usuario.productos_comprados.mapped('monto')))"/>
                                                </td>
                                                <td colspan="2"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </t>
                                <t t-if="not usuario.productos_comprados">
                                    <p><em>No ha comprado ningún producto</em></p>
                                </t>
                            </div>
                        </div>
                        
                        <!-- Valoraciones Recibidas -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h3>Valoraciones Recibidas</h3>
                                <t t-if="usuario.valoraciones_recibidas">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr style="background-color: #f0f0f0;">
                                                <th style="text-align: left; padding: 10px;">Valorador</th>
                                                <th style="text-align: center; padding: 10px;">Valoración</th>
                                                <th style="text-align: left; padding: 10px;">Comentario</th>
                                                <th style="text-align: center; padding: 10px;">Fecha</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="usuario.valoraciones_recibidas" t-as="valoracion">
                                                <tr>
                                                    <td style="padding: 8px;" t-esc="valoracion.usuario_valorador_id.name if valoracion.usuario_valorador_id else 'N/A'"/>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <strong t-esc="valoracion.valoracion"/>
                                                        <span> ⭐</span>
                                                    </td>
                                                    <td style="padding: 8px;" t-esc="valoracion.comentario or 'Sin comentario'"/>
                                                    <td style="text-align: center; padding: 8px;">
                                                        <span t-esc="valoracion.fecha.strftime('%d/%m/%Y') if valoracion.fecha else 'N/A'"/>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </t>
                                <t t-if="not usuario.valoraciones_recibidas">
                                    <p><em>No ha recibido valoraciones</em></p>
                                </t>
                            </div>
                        </div>
                        
                        <div class="oe_structure"/>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <!-- Reporte: Lista de Reportes -->
    <record id="action_report_reportes_lista" model="ir.actions.report">
        <field name="name">Lista de Reportes</field>
        <field name="model">pi.reporte</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">pi_core.report_reportes_lista</field>
        <field name="report_file">pi_core.report_reportes_lista</field>
        <field name="print_report_name">'Lista de Reportes - %s' % (time.strftime('%%Y-%%m-%%d'))</field>
        <field name="paperformat_id" ref="base.paperformat_euro"/>
    </record>
    
    <!-- Servidor de acción para el reporte -->
    <record id="action_server_report_reportes_lista" model="ir.actions.server">
        <field name="name">Imprimir Lista de Reportes</field>
        <field name="model_id" ref="model_pi_reporte"/>
        <field name="binding_model_id" ref="model_pi_reporte"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
action = env.ref('pi_core.action_report_reportes_lista').report_action(records)
        </field>
    </record>

    <!-- Plantilla QWeb: Lista de Reportes -->
    <template id="report_reportes_lista">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <div class="oe_structure"/>
                    
                    <!-- Encabezado -->
                    <div class="row">
                        <div class="col-12">
                            <h1 class="text-center">Lista de Reportes</h1>
                            <p class="text-center">
                                <strong>Fecha del Reporte:</strong> 
                                <span t-esc="time.strftime('%d/%m/%Y %H:%M')"/>
                            </p>
                            <p class="text-center">
                                <strong>Total de Reportes:</strong> 
                                <span t-esc="len(docs)"/>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Resumen por Estado -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h3>Resumen por Estado</h3>
                            <table class="table table-bordered">
                                <thead>
                                    <tr style="background-color: #f0f0f0;">
                                        <th style="text-align: left; padding: 10px;">Estado</th>
                                        <th style="text-align: center; padding: 10px;">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="pendientes" t-value="len([r for r in docs if r.estado == 'pendiente'])"/>
                                    <t t-set="en_revision" t-value="len([r for r in docs if r.estado == 'en_revision'])"/>
                                    <t t-set="resueltos" t-value="len([r for r in docs if r.estado == 'resuelto'])"/>
                                    <t t-set="rechazados" t-value="len([r for r in docs if r.estado == 'rechazado'])"/>
                                    <t t-if="pendientes &gt; 0">
                                        <tr>
                                            <td style="padding: 8px;">Pendiente</td>
                                            <td style="text-align: center; padding: 8px;" t-esc="pendientes"/>
                                        </tr>
                                    </t>
                                    <t t-if="en_revision &gt; 0">
                                        <tr>
                                            <td style="padding: 8px;">En Revisión</td>
                                            <td style="text-align: center; padding: 8px;" t-esc="en_revision"/>
                                        </tr>
                                    </t>
                                    <t t-if="resueltos &gt; 0">
                                        <tr>
                                            <td style="padding: 8px;">Resuelto</td>
                                            <td style="text-align: center; padding: 8px;" t-esc="resueltos"/>
                                        </tr>
                                    </t>
                                    <t t-if="rechazados &gt; 0">
                                        <tr>
                                            <td style="padding: 8px;">Rechazado</td>
                                            <td style="text-align: center; padding: 8px;" t-esc="rechazados"/>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Lista de Reportes -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <h3>Detalle de Reportes</h3>
                            <t t-foreach="docs" t-as="reporte">
                                <div class="mt-3" style="page-break-inside: avoid; border: 1px solid #ddd; padding: 15px; margin-bottom: 20px;">
                                    <div class="row">
                                        <div class="col-12">
                                            <h4>
                                                <span t-esc="reporte.display_name or ('Reporte #' + str(reporte.id))"/>
                                            </h4>
                                        </div>
                                    </div>
                                    
                                    <table class="table table-sm" style="margin-top: 10px;">
                                        <tbody>
                                            <tr>
                                                <td style="width: 25%; padding: 8px;"><strong>ID Reporte:</strong></td>
                                                <td style="padding: 8px;" t-esc="'#' + str(reporte.id)"/>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px;"><strong>Tipo de Reporte:</strong></td>
                                                <td style="padding: 8px;">
                                                    <span t-esc="dict(reporte._fields['tipo_reporte'].selection).get(reporte.tipo_reporte, reporte.tipo_reporte) if reporte.tipo_reporte else 'N/A'"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px;"><strong>Estado:</strong></td>
                                                <td style="padding: 8px;">
                                                    <span t-esc="dict(reporte._fields['estado'].selection).get(reporte.estado, reporte.estado)"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px;"><strong>Fecha:</strong></td>
                                                <td style="padding: 8px;">
                                                    <span t-esc="reporte.fecha.strftime('%d/%m/%Y %H:%M') if reporte.fecha else 'N/A'"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px;"><strong>Reportado Por:</strong></td>
                                                <td style="padding: 8px;" t-esc="reporte.reportado_por_id.name if reporte.reportado_por_id else 'N/A'"/>
                                            </tr>
                                            <tr>
                                                <td style="padding: 8px;"><strong>Referencia:</strong></td>
                                                <td style="padding: 8px;" t-esc="reporte.referencia or 'Sin referencia'"/>
                                            </tr>
                                            <t t-if="reporte.tipo_reporte == 'producto' and reporte.producto_reportado_id">
                                                <tr>
                                                    <td style="padding: 8px;"><strong>Producto Reportado:</strong></td>
                                                    <td style="padding: 8px;" t-esc="reporte.producto_reportado_id.nombre_producto"/>
                                                </tr>
                                            </t>
                                            <t t-if="reporte.tipo_reporte == 'usuario' and reporte.usuario_reportado_id">
                                                <tr>
                                                    <td style="padding: 8px;"><strong>Usuario Reportado:</strong></td>
                                                    <td style="padding: 8px;" t-esc="reporte.usuario_reportado_id.name"/>
                                                </tr>
                                            </t>
                                            <t t-if="reporte.tipo_reporte == 'comentario' and reporte.comentario_reportado_id">
                                                <tr>
                                                    <td style="padding: 8px;"><strong>Comentario Reportado:</strong></td>
                                                    <td style="padding: 8px;" t-esc="reporte.comentario_reportado_id.texto[:100] if reporte.comentario_reportado_id.texto else 'N/A'"/>
                                                </tr>
                                            </t>
                                            <t t-if="reporte.estado in ['resuelto', 'rechazado']">
                                                <tr>
                                                    <td style="padding: 8px;"><strong>Fecha de Resolución:</strong></td>
                                                    <td style="padding: 8px;">
                                                        <span t-esc="reporte.fecha_resolucion.strftime('%d/%m/%Y %H:%M') if reporte.fecha_resolucion else 'N/A'"/>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="padding: 8px;"><strong>Acción Tomada:</strong></td>
                                                    <td style="padding: 8px;">
                                                        <span t-esc="dict(reporte._fields['accion_tomada'].selection).get(reporte.accion_tomada, reporte.accion_tomada) if reporte.accion_tomada else 'N/A'"/>
                                                    </td>
                                                </tr>
                                                <t t-if="reporte.notas_resolucion">
                                                    <tr>
                                                        <td style="padding: 8px;"><strong>Notas de Resolución:</strong></td>
                                                        <td style="padding: 8px;" t-esc="reporte.notas_resolucion"/>
                                                    </tr>
                                                </t>
                                            </t>
                                        </tbody>
                                    </table>
                                    
                                    <div class="mt-2">
                                        <strong>Motivo del Reporte:</strong>
                                        <div style="padding: 10px; background-color: #f8f9fa; border-radius: 4px; margin-top: 5px;">
                                            <p style="margin: 0; white-space: pre-wrap;" t-esc="reporte.motivo"/>
                                        </div>
                                    </div>
                                </div>
                            </t>
                        </div>
                    </div>
                    
                    <div class="oe_structure"/>
                </div>
            </t>
        </t>
    </template>

</odoo>
